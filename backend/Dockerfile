# 1. Base Image
FROM node:20-bookworm-slim AS base

# Ã‡alÄ±ÅŸma dizini
WORKDIR /app

# 2. Sistem baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± yÃ¼kle
# Not: Debian 12 (Bookworm) kullandÄ±ÄŸÄ±n iÃ§in freecad paketini doÄŸrudan apt'den alabiliriz.
RUN apt-get update && apt-get install -y \
    # Node ve Prisma iÃ§in gerekli araÃ§lar
    python3 \
    python3-pip \
    build-essential \
    openssl \
    # Blender indirmek iÃ§in
    wget \
    xz-utils \
    # [YENÄ°] FreeCAD Kurulumu (STEP dosyalarÄ±nÄ± okumak iÃ§in)
    freecad \
    # Blender GUI/Headless kÃ¼tÃ¼phaneleri
    libgl1 \
    libxi6 \
    libxrender1 \
    libxxf86vm1 \
    libxfixes3 \
    libxkbcommon0 \
    libsm6 \
    libxext6 \
    libxcursor1 \
    libxinerama1 \
    libdbus-1-3 \
    libasound2 \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# [YENÄ°] Python KÃ¼tÃ¼phanelerini YÃ¼kle
# Scriptin Ã§alÄ±ÅŸmasÄ± iÃ§in trimesh ve numpy gerekiyor.
# Debian 12'de pip kullanÄ±rken '--break-system-packages' flag'i gerekebilir (Docker iÃ§inde gÃ¼venlidir).
RUN pip3 install trimesh numpy scipy --break-system-packages

# 3. Blender Kurulumu (Cache mekanizmasÄ± iÃ§in package.json'dan Ã¶nce)
WORKDIR /opt/blender
RUN wget https://download.blender.org/release/Blender4.0/blender-4.0.2-linux-x64.tar.xz \
    && tar -xvf blender-4.0.2-linux-x64.tar.xz --strip-components=1 \
    && rm blender-4.0.2-linux-x64.tar.xz

# Blender'Ä± PATH'e ekle
ENV PATH="/opt/blender:$PATH"

RUN npm install -g @gltf-transform/cli

# Kurulum doÄŸrulama
RUN echo "ğŸ” Kurulum kontrolÃ¼..." && \
    blender --version && \
    python3 --version && \
    gltf-transform --version && \
    echo "âœ… TÃ¼m araÃ§lar hazÄ±r!"

# Uygulama dizinine dÃ¶n
WORKDIR /app

# 4. BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
COPY package*.json ./
RUN npm install

# 5. Kaynak kodlarÄ± kopyala
COPY . .

# 6. Prisma Generate (openssl gerektirir)
RUN npx prisma generate

# Port
EXPOSE 3000

# ==========================================
# 2. DEVELOPMENT STAGE (Local GeliÅŸtirme)
# ==========================================
FROM base AS dev
# Localde kod deÄŸiÅŸikliklerini anlÄ±k gÃ¶rmek iÃ§in 'start:dev' Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r.
# Not: docker-compose.dev.yml'de volume bind edileceÄŸi iÃ§in kodlar oradan gelir.
CMD ["npm", "run", "start:dev"]

# ==========================================
# 3. PRODUCTION STAGE (CanlÄ± Sunucu)
# ==========================================
FROM base AS prod
# Production ortamÄ± iÃ§in Typescript kodunu Javascript'e derle
RUN npm run build

# Ortam deÄŸiÅŸkenini production olarak ayarla
ENV NODE_ENV=production

# UygulamayÄ± derlenmiÅŸ (dist) klasÃ¶rÃ¼nden baÅŸlat
CMD ["npm", "run", "start:prod"]